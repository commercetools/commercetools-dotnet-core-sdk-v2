\hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source}{}\doxysection{Dependency\+Injection\+Setup.\+cs}
\label{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source}\index{/Users/mgeorge/workspace/commercetools-\/dotnet-\/api-\/sdk/commercetools.Sdk/commercetools.Base.Client/DependencyInjectionSetup.cs@{/Users/mgeorge/workspace/commercetools-\/dotnet-\/api-\/sdk/commercetools.Sdk/commercetools.Base.Client/DependencyInjectionSetup.cs}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00001}00001 \textcolor{keyword}{using} System;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00002}00002 \textcolor{keyword}{using} System.Collections.Concurrent;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00003}00003 \textcolor{keyword}{using} System.Collections.Generic;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00004}00004 \textcolor{keyword}{using} System.ComponentModel.DataAnnotations;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00005}00005 \textcolor{keyword}{using} System.Linq;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00006}00006 \textcolor{keyword}{using} System.Net;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00007}00007 \textcolor{keyword}{using} System.Net.Http;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00008}00008 \textcolor{keyword}{using} \mbox{\hyperlink{namespacecommercetools}{commercetools}}.\mbox{\hyperlink{namespacecommercetools_1_1_base}{Base}}.\mbox{\hyperlink{namespacecommercetools_1_1_base_1_1_client}{Client}}.\mbox{\hyperlink{namespacecommercetools_1_1_base_1_1_client_1_1_middlewares}{Middlewares}};}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00009}00009 \textcolor{keyword}{using} \mbox{\hyperlink{namespacecommercetools}{commercetools}}.\mbox{\hyperlink{namespacecommercetools_1_1_base}{Base}}.\mbox{\hyperlink{namespacecommercetools_1_1_base_1_1_client}{Client}}.\mbox{\hyperlink{namespacecommercetools_1_1_base_1_1_client_1_1_tokens}{Tokens}};}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00010}00010 \textcolor{keyword}{using} \mbox{\hyperlink{namespacecommercetools}{commercetools}}.\mbox{\hyperlink{namespacecommercetools_1_1_base}{Base}}.\mbox{\hyperlink{namespacecommercetools_1_1_base_1_1_serialization}{Serialization}};}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00011}00011 \textcolor{keyword}{using} Microsoft.\mbox{\hyperlink{classcommercetools_1_1_base_1_1_serialization_1_1_extensions}{Extensions}}.Configuration;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00012}00012 \textcolor{keyword}{using} Microsoft.Extensions.DependencyInjection;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00013}00013 \textcolor{keyword}{using} Microsoft.Extensions.Logging;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00014}00014 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00015}00015 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacecommercetools_1_1_base_1_1_client}{commercetools.Base.Client}}}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00016}00016 \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00017}00017     \textcolor{keyword}{public} \textcolor{keyword}{static} \textcolor{keyword}{class }DependencyInjectionSetup}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00018}00018     \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00019}00019         \textcolor{keyword}{public} \textcolor{keyword}{static} \textcolor{keywordtype}{void} UseHttp(\textcolor{keyword}{this} IServiceCollection services)}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00020}00020         \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00021}00021             services.AddHttpClient();}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00022}00022         \}}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00023}00023 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00024}00024         \textcolor{keyword}{public} \textcolor{keyword}{static} IDictionary<string, IHttpClientBuilder> UseHttpApi(\textcolor{keyword}{this} IServiceCollection services,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00025}00025             IConfiguration configuration, IList<string> clients,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00026}00026             Func<IServiceProvider, ISerializerService> serializerFactory,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00027}00027             Func<HttpResponseMessage, Type> errorResponseTypeMapper,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00028}00028             Func<string, IConfiguration, IServiceProvider, ITokenProvider> tokenProviderSupplier)}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00029}00029         \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00030}00030             \textcolor{keywordflow}{if} (clients.Count() == 1)}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00031}00031             \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00032}00032                 \textcolor{keywordflow}{return} services.UseSingleClient(configuration, clients.First(), serializerFactory, errorResponseTypeMapper, tokenProviderSupplier);}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00033}00033             \}}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00034}00034 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00035}00035             \textcolor{keywordflow}{return} services.UseMultipleClients(configuration, clients, serializerFactory, errorResponseTypeMapper, tokenProviderSupplier);}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00036}00036         \}}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00037}00037 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00038}00038         \textcolor{keyword}{private} \textcolor{keyword}{static} IDictionary<string, IHttpClientBuilder> UseMultipleClients(\textcolor{keyword}{this} IServiceCollection services,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00039}00039             IConfiguration configuration, IList<string> clients,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00040}00040             Func<IServiceProvider, ISerializerService> serializerFactory,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00041}00041             Func<HttpResponseMessage, Type> errorResponseTypeMapper,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00042}00042             Func<string, IConfiguration, IServiceProvider, ITokenProvider> tokenProviderSupplier)}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00043}00043         \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00044}00044             var builders = \textcolor{keyword}{new} ConcurrentDictionary<string, IHttpClientBuilder>();}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00045}00045 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00046}00046             clients.ToList().ForEach(clientName =>}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00047}00047             \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00048}00048                 IClientConfiguration clientConfiguration =}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00049}00049                     configuration.GetSection(clientName).Get<ClientConfiguration>();}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00050}00050                 Validator.ValidateObject(clientConfiguration, \textcolor{keyword}{new} ValidationContext(clientConfiguration), \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00051}00051 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00052}00052                 builders.TryAdd(clientName, services.SetupClient(clientName, errorResponseTypeMapper, serializerFactory));}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00053}00053                 services.AddSingleton(serviceProvider =>}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00054}00054                 \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00055}00055                     var client = ClientFactory.Create(clientName, clientConfiguration,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00056}00056                         serviceProvider.GetService<IHttpClientFactory>(),}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00057}00057                         serializerFactory(serviceProvider),}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00058}00058                         tokenProviderSupplier(clientName, configuration, serviceProvider));}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00059}00059                     client.Name = clientName;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00060}00060                     return client;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00061}00061                 \});}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00062}00062             \});}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00063}00063 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00064}00064             \textcolor{keywordflow}{return} builders;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00065}00065         \}}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00066}00066 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00067}00067         \textcolor{keyword}{private} \textcolor{keyword}{static} IDictionary<string, IHttpClientBuilder> UseSingleClient(\textcolor{keyword}{this} IServiceCollection services,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00068}00068             IConfiguration configuration, \textcolor{keywordtype}{string} clientName,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00069}00069             Func<IServiceProvider, ISerializerService> serializerFactory,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00070}00070             Func<HttpResponseMessage, Type> errorResponseTypeMapper,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00071}00071             Func<string, IConfiguration, IServiceProvider, ITokenProvider> tokenProviderSupplier)}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00072}00072         \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00073}00073             IClientConfiguration clientConfiguration = configuration.GetSection(clientName).Get<ClientConfiguration>();}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00074}00074             Validator.ValidateObject(clientConfiguration, \textcolor{keyword}{new} ValidationContext(clientConfiguration), \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00075}00075 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00076}00076             services.AddSingleton(serviceProvider =>}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00077}00077             \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00078}00078                 var client = ClientFactory.Create(clientName, clientConfiguration,}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00079}00079                     serviceProvider.GetService<IHttpClientFactory>(),}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00080}00080                     serializerFactory(serviceProvider),}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00081}00081                     tokenProviderSupplier(clientName, configuration, serviceProvider));}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00082}00082                 client.Name = clientName;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00083}00083                 \textcolor{keywordflow}{return} client;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00084}00084             \});}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00085}00085 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00086}00086             var builders = \textcolor{keyword}{new} ConcurrentDictionary<string, IHttpClientBuilder>();}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00087}00087             builders.TryAdd(clientName, services.SetupClient(clientName, errorResponseTypeMapper, serializerFactory));}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00088}00088 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00089}00089             \textcolor{keywordflow}{return} builders;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00090}00090         \}}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00091}00091 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00092}00092         \textcolor{keyword}{public} \textcolor{keyword}{static} IHttpClientBuilder SetupClient(\textcolor{keyword}{this} IServiceCollection services, \textcolor{keywordtype}{string} clientName, Func<HttpResponseMessage, Type> errorResponseTypeMapper, Func<IServiceProvider, ISerializerService> serializerFactory)}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00093}00093         \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00094}00094             var httpClientBuilder = services.AddHttpClient(clientName)}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00095}00095                 .ConfigureHttpClient(client =>}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00096}00096                 \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00097}00097                     client.DefaultRequestHeaders.AcceptEncoding.ParseAdd(\textcolor{stringliteral}{"{}gzip"{}});}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00098}00098                     client.DefaultRequestHeaders.AcceptEncoding.ParseAdd(\textcolor{stringliteral}{"{}deflate"{}});}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00099}00099                     client.DefaultRequestHeaders.UserAgent.ParseAdd(\textcolor{keyword}{new} \mbox{\hyperlink{classcommercetools_1_1_base_1_1_client_1_1_middlewares_1_1_user_agent_provider}{UserAgentProvider}}().UserAgent);}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00100}00100                 \})}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00101}00101                 .ConfigureHttpMessageHandlerBuilder(builder =>}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00102}00102                 \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00103}00103                     builder.PrimaryHandler = \textcolor{keyword}{new} HttpClientHandler}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00104}00104                     \{}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00105}00105                         AutomaticDecompression = DecompressionMethods.Deflate | DecompressionMethods.GZip}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00106}00106                     \};}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00107}00107                 \})}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00108}00108                 .AddHttpMessageHandler(c => \textcolor{keyword}{new} ErrorHandler(message => serializerFactory(c).Deserialize(errorResponseTypeMapper(message), message.ExtractResponseBody())))}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00109}00109                 .AddHttpMessageHandler(c => \textcolor{keyword}{new} LoggerHandler(c.GetService<ILoggerFactory>()));}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00110}00110 }
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00111}00111             \textcolor{keywordflow}{return} httpClientBuilder;}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00112}00112         \}}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00113}00113     \}}
\DoxyCodeLine{\Hypertarget{commercetools_8_base_8_client_2_dependency_injection_setup_8cs_source_l00114}00114 \}}

\end{DoxyCode}
